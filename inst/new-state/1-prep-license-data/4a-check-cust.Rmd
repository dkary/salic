---
title: "Check Customers"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: show
---

**Notes**


```{r setup, message=FALSE}
library(tidyverse)
library(lubridate)
library(stringr)
library(readxl)
library(salic)
library(scales)
knitr::opts_chunk$set(comment = NA)
```


## Load

### Customers 

```{r}
f <- "../../../../../Data-sensitive/Data-Dashboards/__state__/standard.sqlite3"
db_standard <- src_sqlite(f)

cust_in <- tbl(db_standard, "cust") %>%
    select(cust_id, sex, dob, last, first, cust_res) %>%
    collect()
glimpse(cust_in)
```


### Sales

*Guidelines: For looking at hunters & anglers over time*

```{r}
# license type to identify hunters & anglers
lic <- read_excel("../data/1-prep-license-data/license-types-prepped.xlsx")

sale <- tbl(db_standard, "sale") %>%
    select(cust_id, lic_id, year, dot) %>%
    collect()
glimpse(sale)
```


## Prep

```{r}
# if needed - drop customers who aren't hunters or anglers
sale <- sale %>%
    left_join(lic, by = "lic_id") %>%
    filter(type %in% c("fish", "hunt", "trap", "combo"), !is.na(type))

cust <- cust_in %>%
    semi_join(sale, by = "cust_id")

# prepare standard variables
cust <- cust %>%
    mutate(dob = ymd(dob), birth_year = year(dob)) %>%
    salic::df_factor_sex() %>%
    salic::df_factor_res("cust_res")

rm(cust_in)
glimpse(cust)
```


## Check customer IDs

### Dups: One customer (last3, first2, dob) - multiple cust_ids

*Guidelines: Names are truncated, which seems to provide a good balance between false negatives (e.g., inconsistent spellings for the same customer) and false positives (e.g., the same last3-first2-dob for different customers)*

*Some number of duplicates is common, probably not a concern if it's fewer than 1 percent or so*

```{r}
# create truncated names
cust <- cust %>%
    mutate(first2 = str_sub(first, end = 2), last3 = str_sub(last, end = 3))

# check coding
cust %>%
    sample_n(5) %>%
    select(last3, last, first2, first)

# check duplication
cust %>%
    select(dob, last3, first2) %>%
    salic::check_dups()
```

*Guidelines: It's worth taking a closer look at duplicates to see if there are any patterns that might lead to skewed results when tracking customers across years.*

```{r}
# select duplicated customers
dup <- cust %>%
    count(first2, last3, dob) %>%
    filter(n > 1)

# investigate a sample of duplicates
sample_n(dup, 20) %>%
    select(first2, last3, dob) %>%
    left_join(cust, by = c("first2", "last3", "dob")) %>%
    left_join(sale, by = "cust_id")
```


### Dups: One cust_id - multiple customers

*Guidelines: Note that this type of duplicate probably won't exist if a customer table (with one row per customer) was provided separately*

```{r}
length(unique(cust$cust_id)) == length(cust$cust_id)
```


## Check Demographics

### Prepare 

```{r}
# angler/hunter identifier
demo_sale <- sale %>%
    mutate(
        hunt = ifelse(type %in% c("hunt", "trap", "combo"), "hunting", NA),
        fish = ifelse(type %in% c("fish", "combo"), "fishing", NA)
    ) %>%
    distinct(cust_id, year, hunt, fish)

# join to demographics
demo_cust <- cust %>%
    select(cust_id, sex, cust_res, birth_year) %>%
    right_join(demo_sale, by = "cust_id") %>%
    # transpose for easy ggplot comparison
    gather(var, sport, hunt, fish, na.rm = TRUE)

rm(demo_sale)
glimpse(demo_cust)
```


### Gender

*Guidelines: Typical Percentages: Hunters: ~5-15% female, Anglers: ~15-30% female. The female percentage is usually increasing over time (particularly for hunting).*

```{r, fig.height=2.5, fig.width=6.5}
x <- demo_cust %>%
    filter(!is.na(sex)) %>%
    count(sport, year, sex) %>%
    group_by(sport, year) %>%
    mutate(pct = n / sum(n))

x %>%
    filter(sex == "Female") %>%
    ggplot(aes(year, pct)) +
    geom_col(fill = "#5ab4ac") +
    facet_wrap(~ sport, scales = "free") +
    scale_y_continuous(labels = percent) +
    labs(title = "Women: % of All License Buyers")
```


### Residency

*Guidelines: Typical Nonresident %: Hunting: 5-30%, Fishing: 15-35%*

```{r, fig.height=2.5, fig.width=6.5}
x <- demo_cust %>%
    filter(!is.na(cust_res)) %>%
    count(sport, year, cust_res) %>%
    group_by(sport, year) %>%
    mutate(pct = n / sum(n))

x %>%
    filter(cust_res == "Nonresident") %>%
    ggplot(aes(year, pct)) +
    geom_col(fill = "#d8b365") +
    facet_wrap(~ sport, scales = "free") +
    scale_y_continuous(labels = percent) +
    labs(title = "Nonresidents: % of All License Buyers")
```


### Age

*Guidelines: Typical Fishing/Hunting Age Group Peak: 40s*

```{r}
# identify age by year (and age category)
demo_cust <- salic::recode_agecat(demo_cust)

demo_cust %>%
    filter(!is.na(age_year), !is.na(sex)) %>%
    ggplot(aes(age_year, group = year, color = year)) +
    geom_freqpoly() +
    facet_wrap(sex ~ sport, scales = "free_y")
```


```{r}
sessionInfo()
```
