---
title: "Standardize data & write to sqlite"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: show
---

```{r setup, message=FALSE}
library(tidyverse)
library(stringr)
library(lubridate)
library(salic)
library(readxl)
source("../func.R")
knitr::opts_chunk$set(comment = NA)
```

## Overview

**Guidelines**

- The purpose is to produce a standardized format to facilitate downstream processing
    + see O365 group > _Analyst Docs > Dashboard Data Dictionary
- This script will vary quite a bit by state
    + Much of it will be copy/pasting from previous scripts (e.g., loading, recoding, deduping)

    
## Load

## License Type Prep
    
## Customer Prep

**Guidelines**

- Can probably largely copy/paste code from previous script

### Gender, DOB, State/Residency

### Birth Year

**Guidelines**

- Keeping date-of-birth out of standardized data so that it is more anonymous

```{r}
cust <- mutate(cust, birth_year = lubridate::year(lubridate::ymd(dob)))
sample_n(cust, 5) %>% select(dob, birth_year)
```

### Drop Customers Not in Sales

**Guidelines**

- Customers that don't make it into the final sales table probably shouldn't be included in the standardized data

```{r}
cust_in <- cust
cust <- semi_join(cust, sale, by = "cust_id")
data.frame(
    nrow(cust_in), nrow(cust),  
    diff_pct = round((nrow(cust_in) - nrow(cust)) / nrow(cust_in) * 100, 2)
)
```

## Sales Prep

**Guidelines**

- Can probably largely copy/paste code from previous script

### Transaction Month

- Calculation of standardized sale month

```{r}
# sample_n(sale, 1000) %>% recode_month()

sale <- recode_month(sale, 0:15)
sale <- select(sale, -issue_month, -issue_year)
sale$month <- as.integer(sale$month)
```

## Identify Sales Residency

- by license type, other sales, state in address

### License Type

```{r}
sale <- select(lic, lic_id, res) %>% left_join(sale)
count(sale, res) %>% mutate(pct = n / sum(n) * 100)
```

### Other Sales

- Choose the most recent identified residency

```{r}
sale$id <- as.integer(row.names(sale))

# get sales without residency defined
sale_nores <- filter(sale, is.na(res)) %>% select(cust_id, id, year)

# identify res
# - preferentially pick another sale by that customer that is nearest in year
# - prefer res == 1 if there are 2 sales in the same year
other_res <- filter(sale, !is.na(res)) %>% 
    select(cust_id, year, res) %>%
    right_join(sale_nores, by = "cust_id") %>%
    mutate(diff = abs(year.y - year.x)) %>%
    select(-cust_id, -year.x, -year.y) %>%
    arrange(id, diff, desc(res)) %>%
    distinct(id, .keep_all = TRUE)
sale <- select(other_res, id, res2 = res) %>%
    full_join(sale, by = "id") %>%
    mutate(res = ifelse(is.na(res), res2, res)) %>%
    select(-res2)
rm(sale_nores, other_res)

count(sale, res) %>% mutate(pct = n / sum(n) * 100)
```

### Address State

```{r}
sale_nores <- filter(sale, is.na(res)) %>% select(cust_id, id)

other_res <- select(cust, cust_id, res2 = res) %>%
    right_join(sale_nores, by = "cust_id")
sale <- select(other_res, id, res2) %>%
    full_join(sale, by = "id") %>%
    mutate(res = ifelse(is.na(res), res2, res)) %>%
    select(-res2)
rm(sale_nores, other_res)

count(sale, res) %>% mutate(pct = n / sum(n) * 100)
```

## Final Coding 

**Guidelines**

- Insure consistency in standardized data (_Analyst Docs > Data Dictionary):
    + types and categories
    + variables included
    + excluding any personally-identifiable data

### Customers

```{r}
cust <- cust %>% mutate(
    sex2 = ifelse(sex == "M", 1, ifelse(sex == "F", 2, NA))
)
count(cust, sex2, sex)

cust <- select(cust, cust_id, sex = sex2, birth_year, res) %>%
    mutate(res = as.integer(res), birth_year = as.integer(birth_year),
           sex = as.integer(sex))
glimpse(cust)
```

### Sales

```{r}
sale <- select(sale, cust_id, lic_id, year, res, dot, month)
sale <- mutate(sale, dot = as.character(dot), lic_id = as.integer(lic_id),
               year = as.integer(year), res = as.integer(res))
glimpse(sale)
```

### License Types

```{r}
lic <- lic %>% mutate(
    lic_id = as.integer(lic_id), 
    duration = as.integer(duration), 
    res = as.integer(res)
)
glimpse(lic)
```

## Write to SQLite

```{r}
dir <- "~/data2/"
db_out <- src_sqlite(file.path(dir, "lic.sqlite3"), create = TRUE)
copy_to(db_out, lic, temporary = FALSE)
copy_to(db_out, cust, temporary = FALSE)
copy_to(db_out, sale, temporary = FALSE)
```

```{r}
sessionInfo()
```
