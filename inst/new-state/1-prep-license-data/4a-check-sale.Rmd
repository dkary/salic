---
title: "Check Sales"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: show
---

**Notes**

Dan Kary Note 02-27-18: Untested template code

**Guidelines**

Look closer at sales data, particularly by date of transaction (dot)

```{r setup, message=FALSE}
library(tidyverse)
library(lubridate)
library(salic)
knitr::opts_chunk$set(comment = NA)
```

## Load

```{r}
db_standard <- src_sqlite("../../../../../Data-sensitive/Data-Dashboards/__state__/standard.sqlite3")
sale <- tbl(db_standard, "sale") %>% 
    collect() %>%
    mutate(dot = ymd(dot))
glimpse(sale)
```

```{r}
lic <- tbl(db, "lic") %>%
    collect()
glimpse(lic)
```

## Prep

```{r}
sale <- inner_join(sale, lic, by = "lic_id")

# additional preparation to look more closely at these dates
sale <- sale %>% mutate(
    dot_year = year(dot),
    dot_mon = month(dot)
)
```

## Check Dates

```{r}
sale %>%
    count(year, year_dot = year(dot_date)) %>%
    mutate(dot_lead_yrs = factor(year - year_dot)) %>%
    ggplot(aes(year, n, fill = dot_lead_yrs)) +
    geom_col() +
    ggtitle(
        "Count of Sales by License Year", 
        "Where dot_lead_yrs shows relative transaction year (1: previous, 0: same, etc.)"
    )
```

**Guidelines**

- Note: purchases in December (for the following year) are common
- License years sometimes don't follow calendar years
    + This can sometimes vary by license type
    + Might need to do some digging based on how things look in the given state
    
### Transaction Month-Year by License Year

```{r}
sale %>%
    count(year, dot_year, dot_mon) %>% 
    DT::datatable()
```

## Check for Dups

```{r}
select(sale, cust_id, lic_id, year) %>% salic::check_dups()
```

**Guidelines**

- Note: People buying the same license more than once in the same year can be common for some license types (e.g., short-term, antlerless deer)
    + it may require closer investigation if there are large percentages of unusual looking duplicates (e.g., annual licenses)
    
```{r}
# this can take a few minutes to run
dup <- count(sale, cust_id, lic_id, year) %>% 
    ungroup() %>% filter(n > 1)
dup_all <- left_join(dup, sale, by = c("cust_id", "lic_id", "year"))

dup_count <- count(dup_all, lic_id, description, year)
all_count <- count(sale, lic_id, description, year)

left_join(dup_count, all_count) %>%
    mutate(pct = round(nn / n * 100, 1)) %>%
    select(-nn, -n) %>%
    spread(year, pct) %>%
    DT::datatable()
```

```{r}
sessionInfo()
```
