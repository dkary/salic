---
title: "Load Raw Data into sqlite database"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: show
---

```{r setup, message=FALSE}
library(tidyverse)
library(salic)
knitr::opts_chunk$set(comment = NA)
```

## Guidelines

- Any cleaning should be minimal (e.g., adding row IDs, dropping empty rows)
- Regarding dates:
    + I recommend just importing with `col_character` (as per the examples below)
    + If date fields are imported with `col_date` (or similar), it's probably best to convert with `as.character()` prior to writing to sqlite

- Regarding large data files:
    + I recommend monitoring Task Manager (Windows) when loading data since state data files can be quite large (and loading too much data into memory can cause your computer to freeze)

## Load

### License Types

```{r}
# path to raw data file
f <- "E:/SA/Data-Dashboards/Data/"

# test
read_lines(f, n_max = 5)
read_csv(f, n_max = 5) %>% glimpse() # see readr documentation for non-csv formats
salic::count_lines_textfile(f) # to ensure correct number of rows after data import
# note: this didn't work for IA license table, so might be worth troubleshooting
# also just opening with a text editor (which shows line number counts) is an idea 
```

```{r}
read_csv(f, n_max = 5) %>% spec() # readr column type specification

# column type specification to use for import (varies by state)
# note: start with output from read_csv() %>% spec()
coltyp <- cols( )

lic <- read_csv(f, col_types = coltyp, progress = FALSE)
glimpse(lic)
```

### Customers

```{r}
f <- "E:/SA/Data-Dashboards/Data/"

# test
read_lines(f, n_max = 5)
read_csv(f, n_max = 5) %>% glimpse()
count_lines_textfile(f)
```

```{r}
# note: defaulting to col_character() tends to produce fewer import problems
read_csv(f, n_max = 5) %>% spec()
coltyp <- cols( )

cust <- read_csv(f, n_max = Inf, col_types = coltyp, progress = FALSE)
problems(cust)
glimpse(cust)
```

### Sales

```{r}
f <- "E:/SA/Data-Dashboards/Data/"

# test
read_lines(f, n_max = 5)
read_csv(f, n_max = 5) %>% glimpse()
count_lines_textfile(f) # to ensure correct number of rows after data import
```

```{r}
read_csv(f, n_max = 5) %>% spec()
coltyp <- cols( )

sale <- read_csv(f, n_max = Inf, col_types = coltyp, progress = FALSE)
problems(sale)
glimpse(sale)
```

## Add Row IDs

```{r}
cust$raw_cust_id <- as.integer(row.names(cust))
tail(cust$raw_cust_id)

sale$raw_sale_id <- as.integer(row.names(sale))
tail(sale$raw_sale_id)
```

## Write to sqlite

```{r}
# suggested naming: "raw-yyyy-qn.sqlite3", where n refers to quarter number
# matching the intended dashboard timeframe (e.g., 2015 quarter 4)
db <- src_sqlite("E:/SA/Data-Dashboards/Data/", create = TRUE) 
copy_to(db, lic, temporary = FALSE)
copy_to(db, cust, temporary = FALSE)
copy_to(db, sale, temporary = FALSE)
```

```{r}
sessionInfo()
```
