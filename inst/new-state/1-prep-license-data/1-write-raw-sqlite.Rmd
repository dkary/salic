---
title: "Load Raw Data into sqlite database"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: show
---

```{r setup, message=FALSE}
library(tidyverse)
library(salic)
knitr::opts_chunk$set(comment = NA)
```

**Notes**

In case you want to include some easily accessible final notes

**Guidelines**

- Any cleaning should be minimal (e.g., adding row IDs, dropping empty rows)
- Regarding dates: I recommend just importing with `col_character` (as per the examples below)

- Regarding large data files:
    + I recommend monitoring Task Manager (Windows) when loading data since state data files can be quite large and R can use up all of a computer's RAM (essentially freezing the machine)

- Regarding file paths:
    + Using relative paths to data by going backward (with ../../etc) is a bit awkward, but it will make the code easier to re-run if the path to the SA folder ever changes

## Load

### License Types

```{r}
# path to raw data file
f <- "../../../../../Data-sensitive/Data-Dashboards/"

# test
read_lines(f, n_max = 3)
read_csv(f, n_max = 5) %>% glimpse() # see readr documentation for non-csv formats

# check line count to ensure correct number of rows after data import
# if this doesn't work, an alternative is to open the file with JujuEdit
salic::count_lines_textfile(f)
```

```{r}
read_csv(f, n_max = 5) %>% spec() # readr column type specification

# column type specification to use for import (varies by state)
# note: start with output from read_csv() %>% spec()
coltyp <- cols( )

lic <- read_csv(f, col_types = coltyp, progress = FALSE)
glimpse(lic)
```

### Customers

```{r}
f <- "../../../../../Data-sensitive/Data-Dashboards/"

# test
read_lines(f, n_max = 5)
read_csv(f, n_max = 5) %>% glimpse()
count_lines_textfile(f)
```

```{r}
# note: defaulting to col_character() tends to produce fewer import problems
read_csv(f, n_max = 5) %>% spec()
coltyp <- cols( )

cust <- read_csv(f, n_max = Inf, col_types = coltyp, progress = FALSE)
problems(cust)
glimpse(cust)
```

### Sales

```{r}
f <- "../../../../../Data-sensitive/Data-Dashboards/"

# test
read_lines(f, n_max = 5)
read_csv(f, n_max = 5) %>% glimpse()
count_lines_textfile(f) # to ensure correct number of rows after data import
```

```{r}
read_csv(f, n_max = 5) %>% spec()
coltyp <- cols( )

sale <- read_csv(f, n_max = Inf, col_types = coltyp, progress = FALSE)
problems(sale)
glimpse(sale)
```


## Add Row IDs

```{r}
lic$raw_lic_id <- as.integer(row.names(lic))
tail(lic$raw_lic_id)

cust$raw_cust_id <- as.integer(row.names(cust))
tail(cust$raw_cust_id)

sale$raw_sale_id <- as.integer(row.names(sale))
tail(sale$raw_sale_id)
```


## Write to sqlite

**Guidelines**

- Naming (db) should match to relevant "raw-[year].sqlite3" folder used above:
    + for example: "../../../../../Data-sensitive/Data-Dashboards/IA/raw-2015.sqlite3"

```{r}
db <- src_sqlite("../../../../../Data-sensitive/Data-Dashboards/", create = TRUE)
copy_to(db, lic, temporary = FALSE)
copy_to(db, cust, temporary = FALSE)
copy_to(db, sale, temporary = FALSE)
```

```{r}
sessionInfo()
```
