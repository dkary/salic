---
title: "Initial Data Check"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: show
---

```{r setup, message=FALSE}
library(tidyverse)
library(salic)
library(tibble)
library(d3heatmap)
options(scipen = 999)
knitr::opts_chunk$set(comment = NA)
```

**Notes**

**Guidelines**

- This script is intended to catch data problems early.
    + Results outside of expected ranges can indicate underlying data issues (incomplete data is probably the most common problem)
    
- Note: churn calculations with `salic::summary_churn()` don't take multi-year & lifetime license sales into account (so churn may be overestimated)

## Load

### Prepped License Table

```{r}
lic <- read_csv("../data/1-prep-license-data/license-types-prepped.csv")
glimpse(lic)
```

### Raw Sales

```{r}
db <- src_sqlite("../../../../../Data-sensitive/Data-Dashboards/")
src_tbls(db)
```

```{r}
# tbl(db, "sale") %>% glimpse()
sale_in <- tbl(db, "sale") %>%
    select(cust_id = TXNL_CUST_ID, year = TXNL_YEAR, lic_id = TXNL_LICN_TYPE) %>%
    collect()
glimpse(sale_in)
```

### Raw Customers

Only customer ID is pulled, because we will just use this table to check customer coverage in the sale vs cust table (to insure we don't have obviously missing data).

```{r}
# tbl(db, "cust") %>% glimpse()
cust <- tbl(db, "cust") %>% 
    select(cust_id = CUST_ID) %>% 
    collect()
glimpse(cust)
```

## Filter Non-Hunting/Angling

**Guidelines**

States sometimes include other types of data (boat registrations, etc.) that we won't use in the dashboard. These can be removed up-front to focus on relevant sales.

```{r}
all_lic <- filter(lic, type %in% c("combo", "hunt", "trap", "fish"))
sale <- semi_join(sale_in, all_lic, by = "lic_id")

# summary of dropped
drop_lic <- filter(lic, !(type %in% c("combo", "hunt", "trap", "fish")))
right_join(sale_in, drop_lic, by = "lic_id") %>%
    count(lic_id, description) %>%
    DT::datatable()
```

## Check Hunters

### Sales & Customers by Year

**Guidelines**

- Compare output of `summary_sale()` to secondary data sources (Shift + click):
- https://wsfrprograms.fws.gov/Subpages/LicenseInfo/Hunting.htm
    + Note that USFWS tracks **paid** license holders, so excluding free transactions can sometimes reconcile perceived differences between USFWS-based and data-based counts
    + Also the newest USFWS data sometimes seems less reliable than the older ranges (perhaps there are revision processes that include more careful data validation)

```{r}
hunt_lic <- filter(lic, type %in% c("combo", "hunt", "trap"))
hunt_sale <- semi_join(sale, hunt_lic, by = "lic_id")
salic::summary_sale(hunt_sale)
```

### Churn

**Guidelines**

Years selected will vary by state (you should include all available license years in the second argument of `summary_churn`)

```{r}
salic::summary_churn(hunt_sale, 2007:2016)
```

### Sales by License Type

**Guidelines**

- Note: I find the heatmap useful for spotting patterns
- Opening the output in a new window usually helps
- It can sometimes be helpful to open table hunt_count in the viewer to look at details

```{r, fig.height=15}
hunt_sale <- select(lic, lic_id, description) %>% right_join(hunt_sale)
hunt_count <- count(hunt_sale, description, year) %>% 
    spread(year, n, fill = 0) %>% data.frame()
row.names(hunt_count) <- hunt_count$description # heatmap uses row names for the y-axis
hunt_count$description <- NULL
d3heatmap(hunt_count, scale = "none", colors = "Blues", Rowv = F, Colv = F,
          dendrogram="none")
```

## Check Anglers

### Sales & Customers by Year

- https://wsfrprograms.fws.gov/Subpages/LicenseInfo/Fishing.htm

```{r}
fish_lic <- filter(lic, type %in% c("combo", "fish"))
fish_sale <- semi_join(sale, fish_lic, by = "lic_id")
salic::summary_sale(fish_sale)
```

### Churn

```{r}
salic::summary_churn(fish_sale, 2007:2016)
```

### Sales by License Type

```{r, fig.height=15}
fish_sale <- select(lic, lic_id, description) %>% right_join(fish_sale)
fish_count <- count(fish_sale, description, year) %>% 
    spread(year, n, fill = 0) %>% data.frame()
row.names(fish_count) <- fish_count$description # heatmap uses row names for the y-axis
fish_count$description <- NULL
d3heatmap(fish_count, scale = "none", colors = "Blues", Rowv = F, Colv = F,
          dendrogram="none")
```


## Check Related Table Coverage

### Customer Coverage

**Guidelines**

- Note: It's important that all customers in the sales table are included in the customer table
    + If the 2 counts below are different, then you might need to get a repull of customer data from the state

```{r}
cust_sale <- semi_join(cust, sale, by = "cust_id")
tribble(
    ~group, ~count,
    "Customers in sales table", distinct(sale, cust_id) %>% nrow(),
    "Customers in customer table", distinct(cust_sale, cust_id) %>% nrow()
)
```

### License Type Coverage

```{r}
lic_sale <- semi_join(lic, sale, by = "lic_id")
tribble(
    ~group, ~count,
    "License Types in sales table", distinct(sale, lic_id) %>% nrow(),
    "License Types in license table", distinct(lic_sale, lic_id) %>% nrow()
)
```

## Output Total Sales Count

**Guidelines**

- This can be useful for closer inspection of sales by year (by individual license type)
    + the full join is used to look for any license types not included in the sales table (which may or may not be a cause for concern if it happens)

```{r}
dir.create("../out/1-prep-license-data")
lic %>%
    select(lic_id, description) %>% 
    right_join(sale, by = "lic_id") %>%
    count(lic_id, description, year) %>% 
    spread(year, n, fill = 0) %>%
    write_csv("../out/1-prep-license-data/license-sales-count.csv")
```

```{r}
sessionInfo()
```
