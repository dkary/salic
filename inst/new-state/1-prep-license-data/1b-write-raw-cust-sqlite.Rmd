---
title: "Load Raw Customer Data into sqlite database"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: show
---

```{r setup, message=FALSE}
library(tidyverse)
library(salic)
knitr::opts_chunk$set(comment = NA)
```

**Notes**

**Guidelines**

- Any cleaning should be minimal (e.g., adding row IDs, dropping empty rows)

- Regarding dates: These should be imported with `col_character()` since sqlite probably won't translate R dates in a useful way

- Regarding large data files: I recommend monitoring Task Manager (Windows) when loading data since state data files can be quite large and R can use up all of a computer's RAM (essentially freezing the machine)


## Load

```{r}
f <- "../../../../../Data-sensitive/Data-Dashboards/__state__/raw-__period__/"

# test
read_lines(f, n_max = 5)
read_csv(f, n_max = 5) %>% glimpse()
salic::count_lines_textfile(f)
```


**Guidelines** 

It's usually worth minimizing `problems()` in the import. My general rule of thumb is that you don't want consistent problems with one or more variables, but rare parsing problems (e.g., with address data) are probably not worth spending much time to fix.

```{r}
# note: defaulting to col_character() tends to produce fewer import problems
read_csv(f, n_max = 5) %>% spec()
coltyp <- cols( )

cust <- read_csv(f, n_max = Inf, col_types = coltyp, progress = FALSE)
problems(cust)
glimpse(cust)
```


## Add Row IDs

```{r}
cust$raw_cust_id <- as.integer(row.names(cust))
tail(cust$raw_cust_id)
```


## Write to sqlite

```{r}
db <- src_sqlite("../../../../../Data-sensitive/Data-Dashboards/__state__/raw-__period__.sqlite3")
copy_to(db, cust, temporary = FALSE)
```

```{r}
sessionInfo()
```
