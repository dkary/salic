---
title: "Write Standardized Intermediate Sales Data to Sqlite"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: show
---

**Notes**

**Guidelines**

Saving an intermediate (standardized) database is useful for expediting downstream validation of customer and sales data. This also gets us about halfway toward the final production data, which simplifies the final step of writing production data. 

A select set of variables should be included in the standardized database (see O365 > _Analyst Docs > Data Dictionary...xlsx). It may be worthwhile to include additional variables for certain states, if we expect extra variables to be useful in the dashboard production.


```{r setup, message=FALSE}
library(tidyverse)
library(stringr)
library(lubridate)
knitr::opts_chunk$set(comment = NA)
```

## Load Sales

```{r}
db <- src_sqlite("../../../../../Data-sensitive/Data-Dashboards/__state__/raw-__period__.sqlite3")
src_tbls(db)
```

```{r}
# tbl(db, "sale") %>% glimpse()
sale <- tbl(db, "sale") %>%
    select(raw_sale_id, cust_id = TXNL_CUST_ID, lic_id = TXNL_LICN_TYPE,
           year = TXNL_YEAR, source_year, dot = TXNL_TIMESTAMP, 
           start_date = TXNL_EFFECT_DATE, end_date = TXNL_EXPIRE_DATE,
           revenue = TXNL_STATE_COST) %>%
    collect()
glimpse(sale)
```

## Prep 

### License Year

```{r}
sale %>% count(year) %>% data.frame()
```

### Transaction Date

```{r}
# select(sale, dot) %>% sample_n(5)
sale <- sale %>% mutate(
    dot_date = str_sub(dot, end = 10) %>% ymd(),
    dot_new = as.character(dot_date)
) 
sale %>%
    sample_n(5) %>%
    select(dot_new, dot)

# check missing
sale %>%
    filter(is.na(dot_new)) %>%
    nrow()

sale %>%
    count(year, year_dot = year(dot_date)) %>%
    mutate(dot_lead_yrs = factor(year - year_dot)) %>%
    ggplot(aes(year, n, fill = dot_lead_yrs)) +
    geom_col() +
    ggtitle(
        "Count of Sales by License Year", 
        "Where dot_lead_yrs shows relative transaction year (1: previous, 0: same, etc.)"
    )
```

### Start Date

```{r}
# select(sale, start_date) %>% sample_n(5)
sale <- sale %>% mutate(
    start_date_date = mdy(start_date),
    start_date_new = as.character(start_date_date)
) 
sale %>%
    sample_n(5) %>%
    select(start_date_new, start_date)

# check missing
sale %>%
    filter(is.na(start_date_new)) %>%
    nrow()

sale %>%
    count(year, year_start_date = year(start_date_date)) %>%
    mutate(start_lead_yrs = factor(year - year_start_date)) %>%
    ggplot(aes(year, n, fill = start_lead_yrs)) +
    geom_col() +
    ggtitle(
        "Count of Sales by License Year", 
        "Where start_lead_yrs shows relative start year (1: previous, 0: same, etc.)"
    )
```


### End Date

```{r}
# select(sale, end_date) %>% sample_n(5)
sale <- sale %>% mutate(
    end_date_date = mdy(end_date),
    end_date_new = as.character(end_date_date)
) 
sale %>%
    sample_n(5) %>%
    select(end_date_new, end_date)

# check missing
sale %>%
    filter(is.na(end_date_new)) %>%
    nrow()

sale %>%
    count(year, year_end_date = year(end_date_date)) %>%
    mutate(end_lead_yrs = factor(year - year_end_date)) %>%
    ggplot(aes(year, n, fill = end_lead_yrs)) +
    geom_col() +
    ggtitle(
        "Count of Sales by License Year", 
        "Where end_lead_yrs shows relative end year (1: previous, 0: same, etc.)"
    )
```

### Revenue

```{r}
sale %>% 
    count(revenue) %>% 
    DT::datatable()

sale %>%
    ggplot(aes(revenue)) +
    geom_histogram() +
    scale_x_log10() +
    xlab("revenue (log10)")

# check missing 
sale %>%
    filter(is.na(revenue)) %>%
    nrow()
```

## Finalize

- Renaming "new" columns and dropping old and unnecessary
- Adding a "source" column in case future data is appended

```{r}
sale <- sale %>% select(
    cust_id, lic_id, year, dot = dot_new, start_date = start_date_new,
    end_date = end_date_new, revenue, raw_sale_id
) %>%
    mutate(source_cust = as.integer("__period__"))
glimpse(sale)
```

## Write to Sqlite

```{r}
f <- "../../../../../Data-sensitive/Data-Dashboards/__state__/standard.sqlite3"
db_out <- src_sqlite(f)
copy_to(db_out, sale, temporary = FALSE)
```

```{r}
sessionInfo()
```
