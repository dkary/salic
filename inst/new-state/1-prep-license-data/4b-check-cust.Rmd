---
title: "Check Customer Data"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: show
---

**Notes**

Dan Kary Note 02-27-18: Untested template code

**Guidelines**

Look more carefully at customer table, in particular:

- customer ID
- Demographic breakouts

```{r setup, message=FALSE}
library(tidyverse)
library(lubridate)
# source("../func.R")
knitr::opts_chunk$set(comment = NA)
```

## Load

### Customers 

```{r}
db <- src_sqlite("~/data/IA_dashboard_2016/standard.sqlite3")
src_tbls(db)
```

```{r}
cust <- tbl(db, "cust") %>%
    select(-raw_id, -zip) %>%
    collect() %>%
    mutate(dob = ymd(dob))
glimpse(cust)
```

### Sales

For checking customer duplicates across sales (e.g., different license types)

```{r}
lic <- tbl(db, "lic") %>%
    collect()
glimpse(lic)
```

```{r}
sale <- tbl(db, "sale") %>%
    select(-sale_id, -raw_id) %>%
    collect()

# drop sales that aren't within the types of interest
sale <- semi_join(sale, lic, by = "lic_id")
glimpse(sale)
```

## Check customer IDs

### Dups: One customer (last_name, first_name, dob) - multiple cust_ids

**Guidelines**

- Some number of duplicates is common, probably not a concern if it's fewer than 1 percent or so
- A `semi_join` is used because sometimes the customer table has additional customers (not found in the sales table). This is okay as long as we aren't missing any license sales that need to be tracked.

```{r}
cust_in <- cust
cust <- semi_join(cust, sale, by = "cust_id")
select(cust, dob, last_name, first_name) %>%
    salic::check_dups()
```

**Guidelines**

- Note: It's worth taking a closer look at duplicates to see if there are any patterns that might lead to skewed results when tracking customers across years
    + the "investigate sample" code below provides a start in that direction

```{r}
# this can take a few minutes to run
dup <- count(cust, first_name, last_name, dob) %>%
    filter(n > 1)
```

```{r}
# investigate a sample of duplicates
sample_n(dup, 100) %>%
    select(first_name, last_name, dob) %>%
    left_join(cust, by = c("first_name", "last_name", "dob")) %>%
    left_join(sale, by = "cust_id") %>%
    DT::datatable()
```

### Dups: One cust_id - multiple customers

**Guidelines**

- Note: This type of duplicate probably won't exist if a customer table (with one row per customer) was provided separately

```{r}
length(unique(cust$cust_id)) == length(cust$cust_id)
```

## Check Hunter Demographics

```{r}
hunt <- cust %>%
    left_join(sale, by = "cust_id") %>%
    filter(year <= 2016)
```

```{r}
hunt <- hunt %>% mutate(
    sex = factor_sex(sex),
    cust_res = factor_res(cust_res)
)
```

### Gender

- Typical Male Hunting: 80-95%
- Female percentage is typically increasing over time

```{r}
count(hunt, sex)
filter(hunt, !is.na(sex)) %>%
    count(year, sex) %>% 
    group_by(year) %>%
    mutate(pct = round(n / sum(n) * 100, 1)) %>%
    select(-n) %>% spread(sex, pct) %>% data.frame()
```

### Residency

- Typical Resident Hunting: 70-95%

```{r}
count(hunt, cust_res)
filter(hunt, !is.na(cust_res)) %>%
    count(year, cust_res) %>% 
    group_by(year) %>%
    mutate(pct = round(n / sum(n) * 100, 1)) %>%
    select(-n) %>% spread(cust_res, pct) %>% data.frame()
```

### Age

```{r}
age_labs = c("0-17", "18-24", "25-34", "35-44", "45-54", "55-64", "65+")
age_breaks = c(-Inf, 17, 24, 34, 44, 54, 64, Inf)

hunt <- hunt %>% mutate(
    age = year - lubridate::year(dob),
    agecat = cut(age, breaks = age_breaks, labels = age_labs)
)
sample_n(hunt, 5) %>% select(dob, year, age, agecat)
```

- Typical Hunting Age Group Peak: 40s

```{r}
count(hunt, agecat) %>% data.frame()
filter(hunt, !is.na(agecat)) %>%
    count(year, agecat) %>% 
    group_by(year) %>%
    mutate(pct = round(n / sum(n) * 100, 1)) %>%
    select(-n) %>% spread(agecat, pct) %>% data.frame()
```

## Check Angler Demographics

### Prep Anglers by Year

```{r}
lic_fish <- filter(lic, type %in% c("combo", "fish"))
sale_fish <- filter(sale, lic_id %in% lic_fish$lic_id) %>% 
    select(cust_id, year) %>% 
    distinct()
fish <- right_join(cust, sale_fish, by = "cust_id")
glimpse(fish)
```

### Gender

- Typical Male fishing: 70-85%
- Female percentage is typically increasing over time

```{r}
count(fish, sex)
filter(fish, !is.na(sex)) %>%
    count(year, sex) %>% 
    group_by(year) %>%
    mutate(pct = round(n / sum(n) * 100, 1)) %>%
    select(-n) %>% spread(sex, pct) %>% data.frame()
```

### Residency

- Typical Resident fishing: 65-85%

```{r}
count(fish, res)
filter(fish, !is.na(res)) %>%
    count(year, res) %>% 
    group_by(year) %>%
    mutate(pct = round(n / sum(n) * 100, 1)) %>%
    select(-n) %>% spread(res, pct) %>% data.frame()
```

### Age

```{r}
age_labs = c("0-17", "18-24", "25-34", "35-44", "45-54", "55-64", "65+")
age_breaks = c(-Inf, 17, 24, 34, 44, 54, 64, Inf)

fish <- fish %>% mutate(
    age = year - lubridate::year(dob),
    agecat = cut(age, breaks = age_breaks, labels = age_labs)
)
sample_n(fish, 5) %>% select(dob, year, age, agecat)
```

- Typical fishing Age Group Peak: 40s

```{r}
count(fish, agecat) %>% data.frame()
filter(fish, !is.na(agecat)) %>%
    count(year, agecat) %>% 
    group_by(year) %>%
    mutate(pct = round(n / sum(n) * 100, 1)) %>%
    select(-n) %>% spread(agecat, pct) %>% data.frame()
```

```{r}
sessionInfo()
```
