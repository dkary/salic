---
title: "Initial Data Check"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: show
---

```{r setup, message=FALSE}
library(tidyverse)
library(readxl)
library(salic)
library(tibble)
library(d3heatmap)
options(scipen = 999)
knitr::opts_chunk$set(comment = NA)
```

## Overview

- (for overall state-specific notes)

**Guidelines**

- This script is intended to catch data problems early.
    + Results outside of expected ranges can indicate underlying data issues (incomplete data is probably the most common problem)
- Note: churn calculations with `salic::summary_churn()` don't take multi-year & lifetime license sales into account (so churn may be overestimated)

## Load Data

**Guidelines**

- only a subset of columns are needed for each table (names will vary by state)
- renaming columns to standard values allows boilerplate code to be applied to different states
- customer data is pulled only to check customer coverage (near end of this script)

### Prepped License Types

```{r}
f <- "../../data/1-prep-license-data/lic_types.xlsx"
lic <- read_excel(f)
lic <- select(lic, TypeCode, TypeName, type)
names(lic) <- c("lic_id", "description", "type")
glimpse(lic)
```

### Raw Sales

```{r}
db <- src_sqlite("~/Data/")
src_tbls(db)
```

```{r}
tbl(db, "sale") %>% glimpse()
sale <- tbl(db, "sale") %>%
    select(CustomerPrimaryID, Season, typecode) %>%
    collect(n = Inf)
names(sale) <- c("cust_id", "year", "lic_id")
glimpse(sale)
```

### Raw Customers

```{r}
tbl(db, "cust") %>% glimpse()
cust <- tbl(db, "cust") %>% 
    select(CustomerID) %>% 
    collect(n = Inf)
names(cust) <- "cust_id"
glimpse(cust)
```

## Check Hunters

### Sales & Customers by Year

**Guidelines**

- Compare output of `summary_sale()` to secondary data sources (Shift + click):
- https://wsfrprograms.fws.gov/Subpages/LicenseInfo/Hunting.htm

```{r}
hunt_lic <- filter(lic, type %in% c("combo", "hunt", "trap"))
hunt_sale <- semi_join(sale, hunt_lic, by = "lic_id")
salic::summary_sale(hunt_sale)
```

### Churn

**Guidelines**

- years selected will vary by state (include all available license years)

```{r}
salic::summary_churn(hunt_sale, 2007:2016)
```

### Sales by License Type

**Guidelines**

- Note: I find the heatmap useful for spotting patterns
- Opening the output in a new window usually helps

```{r, fig.height=10}
hunt_sale <- select(lic, lic_id, description) %>% right_join(hunt_sale)
y <- count(hunt_sale, description, year) %>% 
    spread(year, n, fill = 0) %>% data.frame()
row.names(y) <- y$description # b/c heatmap uses row names for the y-axis
y$description <- NULL
d3heatmap(y, scale = "none", colors = "Blues", Rowv = F, Colv = F, dendrogram="none")
```

## Check Anglers

### Sales & Customers by Year

- https://wsfrprograms.fws.gov/Subpages/LicenseInfo/Fishing.htm

```{r}
fish_lic <- filter(lic, type %in% c("combo", "fish"))
fish_sale <- semi_join(sale, fish_lic, by = "lic_id")
salic::summary_sale(fish_sale)
```

### Churn

```{r}
salic::summary_churn(fish_sale, 2007:2016)
```

### Sales by License Type

```{r, fig.height=10}
fish_sale <- select(lic, lic_id, description) %>% right_join(fish_sale)
y <- count(fish_sale, description, year) %>% 
    spread(year, n, fill = 0) %>% data.frame()
row.names(y) <- y$description # b/c heatmap uses row names for the y-axis
y$description <- NULL
d3heatmap(y, scale = "none", colors = "Blues", Rowv = F, Colv = F, dendrogram="none")
```

## Check Related Table Coverage

### Customer Coverage

**Guidelines**

- Note: It's important that all customers in the sales table are included in the customer table
    + If the 2 counts below are different, then you might need to get a repull of customer data from the state

```{r}
cust_sale <- semi_join(cust, sale, by = "cust_id")
tribble(
    ~group, ~count,
    "Customers in sales table", distinct(sale, cust_id) %>% nrow(),
    "Customers in customer table", distinct(cust_sale, cust_id) %>% nrow()
)
```

### License Type Coverage

```{r}
lic_sale <- semi_join(lic, sale, by = "lic_id")
tribble(
    ~group, ~count,
    "License Types in sales table", distinct(sale, lic_id) %>% nrow(),
    "License Types in license table", distinct(lic_sale, lic_id) %>% nrow()
)
```

## Output Total Sales Count

**Guidelines**

- This can be useful for closer inspection of sales by year (by individual license type)

```{r}
all_sale <- select(lic, lic_id, description, type) %>% right_join(sale)
count(all_sale, type, lic_id, description, year) %>% 
    spread(year, n, fill = 0) %>% 
    write.csv(file = "../../data/1-prep-license-data/sales-by-lic-year.csv", 
              row.names = FALSE)
```

```{r}
sessionInfo()
```
