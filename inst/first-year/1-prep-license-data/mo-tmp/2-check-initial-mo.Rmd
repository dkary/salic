---
title: "Initial Data Check"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: show
---

```{r setup, message=FALSE}
library(dplyr)
library(tidyr)
library(readxl)
library(salic)
library(tibble)
library(d3heatmap)
options(scipen = 999)
knitr::opts_chunk$set(comment = NA)
```

## Guidelines

- Note: churn calculations with `salic::summary_churn()` don't take mutli-year & lifetime license sales into account (so churn may be overestimated)

## Load Data

### Prepped License Types

```{r}
f <- "~/Project/MO_Dashboard/Analysis/data/1-initial-prep/MO license types.xlsx"
f <- "../../data/1-prep-license-data/lic_types.xlsx"
lic <- read_excel(f)
lic <- select(lic, TypeCode, TypeName, type)
names(lic) <- c("lic_id", "description", "type")
glimpse(lic)
```

### Raw Sales & Customers

```{r}
db <- src_sqlite("~/data/MO_Dashboard/raw-tmp.sqlite3")
src_tbls(db)

# only a subset of columns are needed for each table > will vary by state
tbl(db, "cust") %>% head() %>% collect() %>% glimpse()
cust <- tbl(db, "cust") %>% 
    select(CustomerID) %>% 
    collect(n = Inf)
names(cust) <- "cust_id"
glimpse(cust)
```

```{r}
tbl(db, "sale") %>% head() %>% collect() %>% glimpse()
sale <- tbl(db, "sale") %>%
    select(CustomerPrimaryID, Season, typecode) %>%
    collect(n = Inf)
names(sale) <- c("cust_id", "year", "lic_id")
glimpse(sale)
```

## Check Hunters

### Sales & Customers by Year

```{r}
sale <- mutate(sale, lic_id_char = lic_id, lic_id = as.numeric(lic_id))
select(sale, lic_id, lic_id_char) %>% head()
```

Compare to secondary data sources (Shift + click):
- https://wsfrprograms.fws.gov/Subpages/LicenseInfo/Hunting.htm

```{r}
hunt_lic <- filter(lic, type %in% c("combo", "hunt", "trap"))
hunt_sale <- semi_join(sale, hunt_lic, by = "lic_id")
salic::summary_sale(hunt_sale)
```

### Churn

```{r}
# years selected will vary by state
salic::summary_churn(hunt_sale, 2007:2016)
```

### Sales by License Type

```{r, fig.height=10}
# A heatmap is useful for spotting patterns
hunt_sale <- select(lic, lic_id, description) %>% right_join(hunt_sale)
y <- count(hunt_sale, description, year) %>% 
    spread(year, n, fill = 0) %>% data.frame()
row.names(y) <- y$description # b/c heatmap uses row names for the y-axis
y$description <- NULL

# suggestion: Show in New Window
d3heatmap(y, scale = "none", colors = "Blues", Rowv = F, Colv = F, dendrogram="none")
```

## Check Anglers

### Sales & Customers by Year

Compare to secondary data sources (Shift + click):
- https://wsfrprograms.fws.gov/Subpages/LicenseInfo/Fishing.htm

```{r}
fish_lic <- filter(lic, type %in% c("combo", "fish"))
fish_sale <- semi_join(sale, fish_lic, by = "lic_id")
salic::summary_sale(fish_sale)
```

### Churn

```{r}
salic::summary_churn(fish_sale, 2007:2016)
```

### Sales by License Type

```{r, fig.height=10}
fish_sale <- select(lic, lic_id, description) %>% right_join(fish_sale)
y <- count(fish_sale, description, year) %>% 
    spread(year, n, fill = 0) %>% data.frame()
row.names(y) <- y$description # b/c heatmap uses row names for the y-axis
y$description <- NULL
d3heatmap(y, scale = "none", colors = "Blues", Rowv = F, Colv = F, dendrogram="none")
```

## Check Customer Coverage in Sales Table

- It's important that all customers in the sales table are included in the customer table

```{r}
cust_sale <- semi_join(cust, sale, by = "cust_id")
tribble(
    ~group, ~count,
    "Customers in sales table", distinct(sale, cust_id) %>% nrow(),
    "Customers in customer table", distinct(cust_sale, cust_id) %>% nrow()
)
```

## Output Total Sales Count

- This can be useful for closer inspection of sales by year (by individual license type)

```{r}
all_sale <- select(lic, lic_id, description, type) %>% right_join(sale)
count(all_sale, type, lic_id, description, year) %>% 
    spread(year, n, fill = 0) %>% 
    write.csv(file = "../../data/1-prep-license-data/sales-by-lic-year.csv", 
              row.names = FALSE)
```
