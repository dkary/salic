---
title: "Check Customers"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: show
---

```{r setup, message=FALSE}
library(tidyverse)
library(readxl)
library(lubridate)
library(salic)
options(scipen = 999)
knitr::opts_chunk$set(comment = NA)
```

## Overview

**Guidelines**

- This script dives into customer characteristics:
    + Uniquely identifying customers is key for the dashboard, so the customer ID should be checked carefully
    + Demographic distributions are informative and can sometimes reveal data issues

## Load Data

**Guidelines**

- Suggestion: Copy/paste code from 2-check-intial.Rmd
    + For customers, include extra fields: 
    + c("cust_id", "dob", "first_name", "last_name", "sex", "state")

### Prepped License Types

### Raw Sales & Customers

## Check customers IDs

### Dups: One customer (last_name, first_name, dob) - multiple cust_ids

**Guidelines**

- Some number of duplicates is common, probably not a concern if it's fewer than 1 percent or so
- A `semi_join` is used because sometimes the customer table has additional customers (not found in the sales table). This is okay as long as we aren't missing any license sales that need to be tracked.

```{r}
cust_in <- cust
cust <- semi_join(cust, sale, by = "cust_id")
select(cust, dob, last_name, first_name) %>%
    salic::check_dups()
```

**Guidelines**

- Note: It's worth taking a closer look at duplicates to see if there are any patterns that might lead to skewed results when tracking customers across years
    + the "investigate sample" code below provides a start in that direction

```{r}
# this can take a few minutes to run
dup <- group_by(cust, first_name, last_name, dob) %>%
	summarise(count = n() - 1, min_cust_id = min(cust_id)) %>% 
	filter(count != 0)
```

```{r}
# investigate a sample of duplicates
sample_n(dup, 100) %>%
    select(first_name, last_name, dob, min_cust_id) %>%
    left_join(cust, by = c("first_name", "last_name", "dob")) %>%
    left_join(sale, by = "cust_id") %>%
    DT::datatable()
```

### Dups: One cust_id - multiple customers

**Guidelines**

- Note: This type of duplicate won't exist if a customer table (with one row per customer) was provided separately

```{r}
length(unique(cust$cust_id)) == length(cust$cust_id)
```

## Recode Demographic Variables

**Guidelines**

- This enables standardization for checking demographics
- The recoding specification varies by state

### Gender

```{r}
cust <- mutate(cust, sex_new = ifelse(!(sex %in% c("M", "F")), NA, sex))
count(cust, sex_new, sex)
```

### State & Residency

```{r}
data(state_abbreviations) # loads data from salic
DT::datatable(state_abbreviations)
```

```{r}
count(cust, state)
cust <- salic::recode_state(cust, state_abbreviations)
count(cust, state_new, state) %>% DT::datatable()
```

```{r}
cust <- mutate(cust, res = ifelse(state_new == "XX", "res", "nonres"))
count(cust, res, state_new) %>% DT::datatable()
```

### Age

```{r}
# convert string dob to date > varies by state
# run on sample to test
head(cust) %>% select(dob) %>% mutate(dob_new = lubridate::mdy_hms(dob))

cust <- mutate(cust, dob_new = lubridate::mdy_hms(dob))
sample_n(cust, 5) %>% select(dob, dob_new)
```

## Check Hunter Demographics

### Prep Hunters by Year

```{r}
lic_hunt <- filter(lic, type %in% c("combo", "hunt", "trap"))
sale_hunt <- filter(sale, lic_id %in% lic_hunt$lic_id) %>% 
    select(cust_id, year) %>% 
    distinct()
hunt <- right_join(cust, sale_hunt, by = "cust_id")
glimpse(hunt)
```

### Gender

- Typical Male Hunting: 80-95%
- Female percentage is typically increasing over time

```{r}
count(hunt, sex_new)
filter(hunt, !is.na(sex_new)) %>%
    count(year, sex_new) %>% 
    mutate(pct = round(n / sum(n) * 100, 1)) %>%
    select(-n) %>% spread(sex_new, pct) %>% data.frame()
```

### Residency

- Typical Resident Hunting: 70-95%

```{r}
count(hunt, res)
filter(hunt, !is.na(res)) %>%
    count(year, res) %>% 
    mutate(pct = round(n / sum(n) * 100, 1)) %>%
    select(-n) %>% spread(res, pct) %>% data.frame()
```

### Age

```{r}
age_labs = c("0-17", "18-24", "25-34", "35-44", "45-54", "55-64", "65+")
age_breaks = c(-Inf, 17, 24, 34, 44, 54, 64, Inf)

hunt <- hunt %>% mutate(
    age = year - lubridate::year(dob_new),
    agecat = cut(age, breaks = age_breaks, labels = age_labs)
)
sample_n(hunt, 5) %>% select(dob, year, age, agecat)
```

- Typical Hunting Age Group Peak: 40s

```{r}
count(hunt, agecat) %>% data.frame()
filter(hunt, !is.na(agecat)) %>%
    count(year, agecat) %>% 
    mutate(pct = round(n / sum(n) * 100, 1)) %>%
    select(-n) %>% spread(agecat, pct) %>% data.frame()
```

## Check Angler Demographics

### Prep Anglers by Year

```{r}
lic_fish <- filter(lic, type %in% c("combo", "fish"))
sale_fish <- filter(sale, lic_id %in% lic_fish$lic_id) %>% 
    select(cust_id, year) %>% 
    distinct()
fish <- right_join(cust, sale_fish, by = "cust_id")
glimpse(fish)
```

### Gender

- Typical Male fishing: 70-85%
- Female percentage is typically increasing over time

```{r}
count(fish, sex_new)
filter(fish, !is.na(sex_new)) %>%
    count(year, sex_new) %>% 
    mutate(pct = round(n / sum(n) * 100, 1)) %>%
    select(-n) %>% spread(sex_new, pct) %>% data.frame()
```

### Residency

- Typical Resident fishing: 65-85%

```{r}
count(fish, res)
filter(fish, !is.na(res)) %>%
    count(year, res) %>% 
    mutate(pct = round(n / sum(n) * 100, 1)) %>%
    select(-n) %>% spread(res, pct) %>% data.frame()
```

### Age

```{r}
age_labs = c("0-17", "18-24", "25-34", "35-44", "45-54", "55-64", "65+")
age_breaks = c(-Inf, 17, 24, 34, 44, 54, 64, Inf)

fish <- fish %>% mutate(
    age = year - lubridate::year(dob_new),
    agecat = cut(age, breaks = age_breaks, labels = age_labs)
)
sample_n(fish, 5) %>% select(dob, year, age, agecat)
```

- Typical fishing Age Group Peak: 40s

```{r}
count(fish, agecat) %>% data.frame()
filter(fish, !is.na(agecat)) %>%
    count(year, agecat) %>% 
    mutate(pct = round(n / sum(n) * 100, 1)) %>%
    select(-n) %>% spread(agecat, pct) %>% data.frame()
```

```{r}
sessionInfo()
```

