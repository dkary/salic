---
title: "Check Sales"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: show
---

```{r setup, message=FALSE}
library(dplyr)
library(tidyr)
library(readxl)
library(lubridate)
library(salic)
knitr::opts_chunk$set(comment = NA)
```

## Overview

**Guidelines**
- 

## Load Data

### Prepped License Types

**Guidelines**
- Suggestion: Copy/paste code from 2-check-intial.Rmd
    + For sales, include an extra field: "dot" (transaction date)
    + Probably no need to load customer data

### temp

```{r}
f <- "../../data/1-prep-license-data/lic_types.xlsx"
lic <- read_excel(f)
lic <- select(lic, TypeCode, TypeName, type)
names(lic) <- c("lic_id", "description", "type")
glimpse(lic)
```

### Raw Sales

### temp

```{r}
<<<<<<< HEAD:inst/first-year/1-prep-license-data/4-check-sales.Rmd
# db <- src_sqlite("~/Data/")
db <- src_sqlite("~/Data/MO_Dashboard/raw-samp.sqlite3")
=======
db <- src_sqlite("~/Data/")
db <- src_sqlite("~/Data/MO_Dashboard/raw-tmp.sqlite3") ### temp
>>>>>>> 8860f840b4d0864c1c1eaf3166e760be44c9f547:inst/first-year/1-prep-license-data/3-check-sales-mo.Rmd
src_tbls(db)
```

### TEST - just for fun

- This might end up being a good way to interact with the database backend
    + especially for someone like Martin who is probably already good at sql

```{r}
# test sql
library(DBI)
db <- dbConnect(RSQLite::SQLite(), dbname = "~/Data/MO_Dashboard/raw-samp.sqlite3")
```

```{sql, connection = db}
select CustomerID, Gender from cust limit 5
```

```{r}
tbl(db, "sale") %>% head() %>% collect() %>% glimpse()
sale <- tbl(db, "sale") %>% 
    select(CustomerPrimaryID, typecode, Season, PurchaseDate) %>%
    collect(n = Inf)
names(sale) <- c("cust_id", "lic_id", "year", "dot")
sale <- mutate(sale, lic_id = as.numeric(lic_id)) ### temp
glimpse(sale)
```

## Check for Dups

```{r}
select(sale, cust_id, lic_id, year) %>% salic::check_dups()
```

**Guidelines**
- Note: People buying the same license more than once in the same year can be common for some license types (e.g., short-term, antlerless deer)
    + it may require closer investigation if there are large percentages of unusual looking duplicates (e.g., annual licenses)
    
```{r}
# this can take a few minutes to run
dup <- count(sale, cust_id, lic_id, year) %>% 
    ungroup() %>% filter(n > 1)
dup_all <- left_join(dup, sale, by = c("cust_id", "lic_id", "year")) %>%
    left_join(lic, by = "lic_id")

count(dup_all, lic_id, description, year) %>%
    spread(year, nn) %>%
    DT::datatable()
```

## Check Dates - START HERE

- Important!!! > need to look at inst/first-year/func.R
    + decide whether to store these functions in salic (probably) or as a template
    + maybe store in template Rmd for the time being, or just get a subset into salic (recode_month, etc.)

```{r}
# convert string to date > varies by state
# run on sample to test
head(sale) %>% select(dot) %>% mutate(dot_new = lubridate::mdy_hms(dot))

sale <- mutate(sale, dot_new = lubridate::mdy_hms(dot))
sample_n(sale, 5) %>% select(dot, dot_new)
```

**Guidelines**
- Note: purchases in December (for the following year) are common
- License years sometimes don't follow calendar years
    + This can vary by license type

```{r}
sale <- sale %>% mutate(
    dot_year = lubridate::year(dot_new),   
    dot_month = lubridate::month(dot_new)
)
sale %>%
    sample_n(5) %>% 
    select(dot, dot_year, dot_month)
sale %>%
    count(year, dot_year, dot_month) %>% 
    DT::datatable()
```
