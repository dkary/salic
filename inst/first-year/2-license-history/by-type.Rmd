---
title: "Create privilege tables by type (hunters, anglers, trappers)"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
output: 
    html_document:
        toc: true
        toc_float: true
        code_folding: show
params:
    type: one_day_fishing
    priv: TRUE
    yrs: 2011:2015
    test: FALSE
---

<!-- Allows horizontal scrollbars in wide output (e.g., license sales by year) --> 
<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

```{r setup, message=FALSE}
library(dplyr)
library(tidyr)
library(RSQLite)
library(salic)
library(tibble)
library(DT)
library(stringr)
source("../func.R")
knitr::opts_chunk$set(comment = NA)
```

```{r}
params$type
```

```{r}
get_range <- function(x) {
    y <- stringr::str_split_fixed(x, ":", 2)
    `:`(y[1], y[2])
}
yrs <- get_range(params$yrs)
yrs
```

## Load

### License Types

- note: will need a more flexible specification in some cases
- MO will be a good use case

```{r}
db_file <- "~/data2/WI_dashboard_2016/lic.sqlite3"
db <- src_sqlite(db_file)
lic <- tbl(db, "lic") %>% collect()

if (params$priv) {
    lic <- filter(lic, priv == params$type)
} else {
    if (params$type == "hunt") {
        lic <- filter(lic, type %in% c("trap", "hunt", "combo"))
    }
    if (params$type == "fish") {
        lic <- filter(lic, type %in% c("fish", "combo"))
    }
    if (params$type == "trap") {
        lic <- filter(lic, type == "trap")
    }
}
DT::datatable(lic)
```


### Sales

```{r}
if (nrow(lic) == 1) {
   sale <- tbl(db, "sale") %>% filter(lic_id == lic$lic_id) 
} else {
    sale <- tbl(db, "sale") %>% filter(lic_id %in% lic$lic_id) 
}
sale <- select(sale, cust_id, lic_id, year, res, dot) %>% collect(n = Inf)
glimpse(sale)
```

### Customers

```{r}
cust <- tbl(db, "cust") %>% select(cust_id, sex, birth_year) %>% collect(n = Inf)
cust <- semi_join(cust, sale, by = "cust_id")
glimpse(cust)
```


### Sample

- For testing, take a sample of about 1000 license holders

```{r}
if (params$test) {
    sample_size <- min(1000, nrow(cust))
    cust <- sample_n(cust, sample_size)
    sale <- semi_join(sale, cust, by = "cust_id")
    glimpse(sale)
}
```

## Check

```{r}
summary_sale(sale)
```

```{r}
summary_churn(sale, head(yrs, -1))
```

## License Privilege Table

- Used for flexible matching in database

```{r}
# match priv name with output table name
out_nm <- paste("priv", params$type, sep = "_")
# if (params$make_indexes) out_nm <- paste(out_nm, "index", sep = "_")

lic_priv <- select(lic, lic_id)
lic_priv$priv <- out_nm
lic_priv <- select(lic_priv, priv, lic_id)
glimpse(lic_priv)
```

## Attach Variables

- This is done so that all variables for building the dashboard is included in each privilege table
    + The idea is that we might create data duplication, but we can query on the privilege table without an initial join
    + It's probably not worth it (at least right now) just to make things go a bit faster for a potential data mining product
    + I did go ahead and include age category since that requires some calculation

### Age

- Calculation of age category

```{r}
sale <- left_join(sale, cust, by = "cust_id")
sale <- recode_age(sale)
sale <- select(sale, -birth_year, -age_year, -agecat)
```

### Gender - NOT RUN

```{r, eval = FALSE}
count(sale, year, sex) %>% spread(sex, n) %>% data.frame()
```

### County - NOT RUN

```{r, eval = FALSE}
sale$county <- 1L
count(sale, county)
```

## Prep

### Rank

- Creates one row per customer-year

```{r}
sale <- mutate(sale, duration = 1) # no multi-year or lifetime licenses
sale_unranked <- sale

sale <- salic::rank_sale(sale, "res") # make tracking tables (in list)
# salic::check_rank_sale(sale, sale_unranked, check_duration = FALSE)
tribble(
    ~group, ~count,
    "Before ranking", nrow(sale_unranked),
    "After ranking", nrow(sale)
)
```

### License History

```{r, message=FALSE}
options(width = 180) # for wide year spread layout

track <- salic::make_track(sale, yrs)
salic::check_make_track(track, sale)
```

### Initial Priv

```{r, message=FALSE}
priv <- salic::make_priv(track)

# only run this if R3 is present
R3_rows <- filter(priv[[length(priv)]], !is.na(R3)) %>% nrow()
if (R3_rows > 0) salic::check_make_priv(priv)
```

### Final Priv

```{r}
# (drops rows where customer didn't buy in a given year)
priv <- priv %>% salic::make_priv_final(
    keep = c("cust_id", "year", "lapse", "R3", "res", "age")
)

### need to change this code to match new category specification
mutate(priv, R3 = factor(R3, levels = 1:4, 
       labels = c("Carried", "Retained", "Reactivated", "Recruited"))) %>%
    check_make_priv_final()

mutate(priv, R3 = factor(R3, levels = 1:4,  
       labels = c("Carried", "Retained", "Reactivated", "Recruited"))) %>%
    group_by(res) %>% check_make_priv_final()
```

## Finalize

### Check Counts

```{r}
nrow(sale) == nrow(priv)
```

### Final Formatting

```{r}
options(width = 80) # back to a normal width

priv <- priv %>% mutate(
    year = as.integer(year), lapse = as.integer(lapse), R3 = as.integer(R3)
)
glimpse(priv)
```

## Save

```{r}
if (!(params$test)) {
    con <- dbConnect(SQLite(), dbname = db_file)
    
    ### Privilege Table
    if (out_nm %in% dbListTables(con)) dbRemoveTable(con, out_nm)
    dbWriteTable(con, out_nm, data.frame(priv))
    
    ### Lic Priv Table
    # create table if it doesn't yet exist
    if (!("lic_priv" %in% dbListTables(con))) {
        dbWriteTable(con, "lic_priv", data.frame(lic_priv))
    } else {
        # overwrite selected priv records to insure only the newest is kept
        lic_priv_old <- tbl(db, "lic_priv") %>% collect()
        lic_priv_old <- filter(lic_priv_old, priv != out_nm)
        lic_priv <- bind_rows(lic_priv, lic_priv_old)
        dbRemoveTable(con, "lic_priv")
        dbWriteTable(con, "lic_priv", data.frame(lic_priv))
    }
    dbDisconnect(con)
}
```

