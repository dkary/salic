---
title: "Introduction to salic"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE, message = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7
)
library(dplyr)
library(salic)
# library(devtools)
# devtools::load_all()
```

```{r}
# playing around
library(ggplot2)
data(dashboard)

dashboard %>%
    filter(metric == "participants", segment == "Gender") %>%
    ggplot(aes(year, value, fill = category)) +
    geom_col() +
    facet_wrap(~ group) +
    ggtitle("Hunter vs. Anglers over Time",
            "'all_sports' refer to those who are both hunters and anglers")
```

```{r}
# test
data(history, package = "salic")
est_part(history)
```

Could maybe present an example of how to dig into questions using the license history. Perhaps this would go at the very end if I want to include it.

Processing data for dashboard involves successive steps:

1. **Standardize Data**: First get necessary license data into a standard (anonymized) format well-suited for generalized data processing functions.

2. **Build License History**: Convert into a license history, which tracks license holding at the permission level across years, enabling easy calculation of dashboard metrics.

3. **Calculate Dashboard Metrics**: Apply estimation functions to license history data, which produces the summaries used as input to the dashboard software.

## TODO

- obviously do some outlining/thinking about a good narrative, could potentially use the existing Word documentation to help this process.
- running R code to show sample data, operations,

## Standardizing License Data

These need to be prepared into a standardized format (which is also anonymized to remove any personally-identifiable information).

This process is state-specific since agencies vary in how license data is stored. The standardization is intended to produce a standard format that is well-suited for the generalized presented here. An important part of this step involves anonymizing data by excluding any personally identifiable information from the standard storage format.

### Sample Data

To get started, first load package dependencies:

```r
library(salic)
library(dplyr)
```

Samples of standardized data are provided in salic:

```{r}
data(cust)
glimpse(cust)

data(lic)
glimpse(lic)

data(sale)
glimpse(sale)
```

A function is provided to check that your data fits the specifications (strict for this reason...):

```r
# produces no output (i.e., silent) if no issues detected
check_format(cust, lic, sale)
```

## Building License History

- `rank_sale()` to do this...
    + `join_first_month()` to do that...
    
- `make_lic_history()`
    + `identify_R3()`
    + `identify_lapse()`

Need to also consider the key parameters for this process:

- permission: specifically related to license types include (fish, hunt, combo)
- timeframe: full-year or mid-year
- years

## Calculating Dashboard Metrics

- filter by age
- `label_categories()` & `recode_agecat()`
- `est_part()`, `est_recruit()`, `est_churn()`

### Formatting for final Output


## License History Data Mining Example

```{r}
data(history)
x <- history %>%
    label_categories() %>%
    recode_agecat()

filter(x, !is.na(sex), !is.na(lapse)) %>%
    group_by(sex) %>%
    summarise(churn = mean(lapse)) %>%
    ggplot(aes(sex, churn)) +
    geom_col() +
    ggtitle("Women churn at a higher rate than men")

filter(x, !is.na(sex), !is.na(R3)) %>%
    count(sex, R3) %>%
    ggplot(aes(R3, n)) +
    geom_col() +
    facet_wrap(~ sex, scales = "free") +
    ggtitle("But, women are more likely to be recruits (a higher churn group)")

filter(x, !is.na(sex), !is.na(R3), R3 == "Recruit", !is.na(lapse), !is.na(agecat)) %>%
    group_by(sex, agecat) %>%
    summarise(churn = mean(lapse)) %>%
    ggplot(aes(sex, churn)) +
    geom_col() +
    facet_wrap(~ agecat, nrow = 2) +
    ggtitle("Not clear that femail recruits churn at a higher rate than male recruits",
            "Although maybe an exception for youths, complex dynamics could be at work")
```

```{r}

# I thought this would disappear, but it doesn't
# previously retained women appear especially more likely to churn
filter(x, !is.na(sex), !is.na(lapse), !is.na(R3)) %>%
    group_by(sex, R3) %>%
    summarise(churn = mean(lapse)) %>%
    ggplot(aes(sex, churn)) +
    geom_col() +
    facet_wrap(~ R3)

# look closer at retained by gender, maybe age is playing a role?
filter(x, !is.na(sex), !is.na(lapse), !is.na(R3), !is.na(agecat)) %>%
    filter(R3 == "Retain") %>%
    group_by(sex, agecat) %>%
    summarise(churn = mean(lapse)) %>%
    ggplot(aes(sex, churn)) +
    geom_col() +
    facet_wrap(~ agecat)

filter(x, !is.na(sex), !is.na(lapse), !is.na(R3), !is.na(agecat)) %>%
    filter(R3 == "Recruit") %>%
    group_by(sex, agecat) %>%
    summarise(churn = mean(lapse)) %>%
    ggplot(aes(sex, churn)) +
    geom_col() +
    facet_wrap(~ agecat)

# of course it is difficult to infer alot from this sample...
# perhaps women have lower avidity generally
# recruits who are women don't seem to be any more likely to churn out

x %>%
    filter(!is.na(agecat), !is.na(R3), !is.na(lapse), !is.na(sex),
           age_year >= 18, age_year <= 64) %>%
    group_by(R3, sex, agecat) %>%
    summarise(churn = mean(lapse)) %>%
    ggplot(aes(agecat, churn)) +
    geom_col() +
    facet_grid(sex ~ R3) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    ggtitle("Churn rates by R3, gender, age (all_sports permission)")
```
