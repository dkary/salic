---
title: "Introduction to salic"
output: 
    rmarkdown::html_vignette:
        toc: TRUE
    md_document:
        toc: TRUE
        variant: markdown_github
vignette: >
  %\VignetteIndexEntry{Introduction to salic}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r setup, include = FALSE, message = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7
)
library(dplyr)
library(salic)
```

## Overview

Salic provides a set of functions to progress from state license data to dashboard summaries. It also includes package dplyr on installation (see [the dplyr intro](https://dplyr.tidyverse.org/)). You'll want to load both packages when using salic:

```{r}
library(salic)
library(dplyr)
```

This vignette walks through salic functionality using provided sample data. A function reference
can be accessed by running `?salic` from the R console; it's organization mirrors this vignette.

## Standardized License Data

To facilitate a generalized workflow, salic is strict about data formatting, and some up-front effort is needed to standardize the relevant state-level data. That said, the dashboard data needs are fairly light (9 variables total in 3 tables).

Salic documents each table's formatting expectations (see `?cust`, `?sale`, `?lic` for details). The 3 tables should be related by 2 key columns (cust_id, lic_id):

![](relations.png)

### Primary Keys

The `cust$cust_id` and `lic$lic_id` variables represent primary key columns (i.e., they must uniquely identify rows in the table):

```{r}
# load sample data
data(cust, lic, sale) 

# check customer ID
length(unique(cust$cust_id)) == nrow(cust)

# check license type ID
length(unique(lic$lic_id)) == nrow(lic)
```

*Note that although keys can be stored as type character, numeric values will yield better performance.*

### Checking Formatting Rules

Salic helps you follow it's formatting rules with an included function (see `?data_check`). The function call is silent if all checks pass; warnings will be printed for every failed check.

```{r}
# prints no warnings
data_check(cust, lic, sale) 

# introduce 1 rule-breaking change
cust_tmp <- cust
cust_tmp$birth_year <- NULL
data_check(cust_tmp, lic, sale)

# introduce a change that breaks 2 rules
cust_tmp <- cust
cust_tmp$cust_id[1:2] <- 1
data_check(cust_tmp, lic, sale)
```

### Categorical Variables

Salic expects specific numeric codes for categorical variables. For example, "sex" must be 1 of 3 values for every customer (1, 2, or NA). You can view the corresponding labels using `salic::label_categories`.

```{r}
count(cust, sex)

label_categories(cust) %>% count(sex)
```

### sale: year & month

The "year" and "month" variables indicate the date of purchase (1 = Jan, 2 = Feb, etc.). The month variable is needed for building "mid-year" dashboards, which present a year-to-year view for the first six months of sales.

```{r}
# all customers per year after 2015
filter(sale, year > 2015) %>%
    distinct(cust_id, year) %>% 
    count(year)

# customers in the first six months only
filter(sale, year > 2015, month <= 6) %>%
    distinct(cust_id, year) %>%
    count(year)
```

### lic: type

The lic table includes two columns important for customer trending. The "type" column specifies whether a license provides:

- a hunting privilege: "hunt"
- a fishing privilege: "fish" 
- or both: "combo"

```{r}
count(lic, type)

# count hunters for select years
filter(lic, type %in% c("hunt", "combo")) %>%
    inner_join(sale, by = "lic_id") %>%
    filter(year > 2015) %>%
    distinct(cust_id, year) %>%
    count(year)
```

### lic: duration

The "duration" column is necessary for building a license history. License types can be organized into 3 groups with respect to this variable:

- Multi-years: duration > 1 (2 = 2-year, 3 = 3-year, etc.)
- Lifetimes: duration = 99
- All others: duration = 1

```{r}
count(lic, duration)

# customers who buy 3-year licenses
cust_3yr <- filter(lic, duration == 3) %>%
    inner_join(sale, by = "lic_id") %>%
    filter(year > 2015) %>%
    distinct(cust_id, year)
count(cust_3yr, year)
```

The presence of multi-year buyers means that an extra step is needed to produce customer trends. The next section goes over building a license history table to facilitate on-the-fly trending & automated summarization. 

## License History

START HERE

Also think about whether the above is too much of a data dump...it might be good to show the workflow that is needed earlier. There is a risk that people will begin reading and just give up.

### rank_sale


### make_history

#### R3

#### Lapse


## Dashboard Metrics

- filter by age
- `label_categories()` & `recode_agecat()`
- `est_part()`, `est_recruit()`, `est_churn()`

## Summary Output
