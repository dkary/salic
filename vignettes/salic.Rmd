---
title: "Introduction to salic"
output: 
    md_document:
        toc: TRUE
        variant: markdown_github
    html_document:
        toc: TRUE
vignette: >
  %\VignetteIndexEntry{Multi-format vignettes}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::multiformat}
---

```{r setup, include = FALSE, message = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7
)
library(dplyr)
library(salic)
```

## Overview

Salic helps you progress from license data to dashboard summaries. It also provides package dplyr on installation ([dplyr intro](https://cran.r-project.org/web/packages/dplyr/vignettes/dplyr.html)). You'll want to load both packages:

```{r}
library(salic)
library(dplyr)
```

This vignette walks through salic functionality using provided sample data (see `?data_salic` for details).

## Standardized License Data

To provide a generalized workflow, salic is strict about the input license data format. That said, the dashboard data needs are fairly light: 3 tables related by 2 keys:

<br>
![](relations.png)

<br>

Salic provides formatting rules in the documentation (see `?cust`, `?lic`, `?sale`). An overview of each table is included below.

### Customers (cust)

Three customer columns are needed; "cust_id" being the most important; it should uniquely identify every row in the table (i.e., it's a primary key).

```{r}
data(cust)
glimpse(cust)

length(unique(cust$cust_id)) == nrow(cust)
```

Salic expects specific codes for categorical variables. For example, "sex" can include 3 values: 

```{r}
count(cust, sex)

# you can check categorical codes using salic::label_categories()
label_categories(cust) %>% count(sex)
```

Functions are provided to check your data against the formatting rules (see `?data_check_table` for details):

```{r}
# silent if all checks pass
data_check_cust(cust) 

# prints a warning for every check that doesn't pass
tmp <- cust
tmp$cust_id[1:2] <- "dupkey"
tmp$birth_year <- NULL
data_check_cust(tmp)
```

### License Types (lic)

Three license type columns are needed. Similar to customers, license types should be uniquely identified using a "lic_id" column.

```{r}
data(lic)
glimpse(lic)

length(unique(lic$lic_id)) == nrow(lic)
```

Unlike the customer table, no missing values are allowed in the license types table:

```{r}
tmp <- lic
tmp$type[1] <- NA
tmp$duration[1] <- NA
data_check_lic(tmp)
```

The "type" column specifies whether a license provides a hunting privilege ("hunt"), a fishing privilege ("fish"), or both ("combo").

```{r}
count(lic, type)
```

The "duration" column is necessary for building a license history. Specifically:

- multi-year licenses hold values according to the number of years they last
- Lifetimes are identified using a special value: 99
- All other license types should = 1.

```{r}
count(lic, duration)
```

### License Sales (sale)

The license sale table includes 5 variables. No primary key is needed; the table links to customers and license types using foreign keys.

```{r}
data(sale)
glimpse(sale)
```

The "year" and "month" variables indicate the date of purchase. bla di bla...

```{r}

```

The "res" variable, bla di bla...

```{r}

```

## License History

- `rank_sale()` to do this...
    + `join_first_month()` to do that...
    
- `make_lic_history()`
    + `identify_R3()`
    + `identify_lapse()`

Need to also consider the key parameters for this process:

- permission: specifically related to license types include (fish, hunt, combo)
- timeframe: full-year or mid-year
- years

## Dashboard Metrics

- filter by age
- `label_categories()` & `recode_agecat()`
- `est_part()`, `est_recruit()`, `est_churn()`

### Summary Output

## Older - keep temporarily


Automatic labelling is also provided (via `label_categories`); this can be used to help check the coding:

```{r}
label_categories(cust) %>% count(sex)
```
