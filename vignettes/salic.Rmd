---
title: "Introduction to salic"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE, message = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7
)
library(dplyr)
library(salic)
```

Salic helps you get from license data to dashboard summaries. It also provides package dplyr on installation ([dplyr intro](https://cran.r-project.org/web/packages/dplyr/vignettes/dplyr.html)). You'll want to load both packages:

```{r}
library(salic)
library(dplyr)
```

This vignette walks through salic functionality using provided sample data (run `?data_salic` for more info).

## Standardized Data

To provide a generalizable workflow, salic is strict about the input license data format. Fortunately, the data needs for dashboard production are light: 3 tables (cust, lic, sale) with 9 columns total.

### Customers (cust table)

Three customer columns are needed. The cust_id column is the most important; it should uniquely identify every row (i.e., it's a primary key).

```{r}
data(cust)
glimpse(cust)

length(unique(cust$cust_id))
```

Salic expects specific numeric coding for categorical variables (run `?cust` for details). Automatic labelling (via `label_categories`) is provided to help you check the coding:

```{r}
count(cust, sex)

tmp <- label_categories(cust)
count(tmp, sex)
```

More generally, you can also check all formatting rules at once (see `?data_check_table` for details):

```{r}
# silent if checks passes
data_check_cust(cust) 

# warns for every check that doesn't pass
tmp <- cust
tmp$sex[1] <- 3
tmp$cust_id[2] <- 1
data_check_cust(tmp)
```


### License Types (lic table)


### License Sales (sale table)

```{r}

```


## Standardizing License Data

These need to be prepared into a standardized format (which is also anonymized to remove any personally-identifiable information).

This process is state-specific since agencies vary in how license data is stored. The standardization is intended to produce a standard format that is well-suited for the generalized presented here. An important part of this step involves anonymizing data by excluding any personally identifiable information from the standard storage format.

### Sample Data

To get started, first load package dependencies:

```r
library(salic)
library(dplyr)
```

Samples of standardized data are provided in salic:

```{r}
data(cust)
glimpse(cust)

data(lic)
glimpse(lic)

data(sale)
glimpse(sale)
```

A function is provided to check that your data fits the specifications (strict for this reason...):

```r
# produces no output (i.e., silent) if no issues detected
check_format(cust, lic, sale)
```

## Building License History

- `rank_sale()` to do this...
    + `join_first_month()` to do that...
    
- `make_lic_history()`
    + `identify_R3()`
    + `identify_lapse()`

Need to also consider the key parameters for this process:

- permission: specifically related to license types include (fish, hunt, combo)
- timeframe: full-year or mid-year
- years

## Calculating Dashboard Metrics

- filter by age
- `label_categories()` & `recode_agecat()`
- `est_part()`, `est_recruit()`, `est_churn()`

### Formatting for final Output

